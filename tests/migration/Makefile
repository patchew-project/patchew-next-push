#
# Copyright (c) 2016-2018 Red Hat, Inc. and/or its affiliates
#
# Authors:
#   Dave Gilbert <dgilbert@redhat.com>
#
# This work is licensed under the terms of the GNU GPL, version 2 or later.
# See the COPYING file in the top-level directory.
#
path := $(subst :, ,$(PATH))
system := $(shell uname -s | tr "A-Z" "a-z")

cross-ld = $(firstword $(wildcard $(patsubst %,%/$(1)-*$(system)*-ld,$(path))))
cross-gcc = $(firstword $(wildcard $(patsubst %ld,%gcc,$(call cross-ld,$(1)))))
find-cross-prefix = $(subst gcc,,$(notdir $(call cross-gcc,$(1))))

x86_64_cross_prefix := $(call find-cross-prefix,x86_64)
aarch64_cross_prefix := $(call find-cross-prefix,aarch64)

export __note
override define __note
/* This file is automatically generated from
 * tests/migration/$<, edit that and then run
 * "make $@" inside tests/migration to update,
 * and then remember to send both in your patch submission.
 */
endef

all: x86-a-b-bootblock.h aarch64-a-b-kernel.h

x86-a-b-bootblock.h: x86-a-b-bootblock.S
	$(x86_64_cross_prefix)gcc -m32 -march=i486 -c $< -o x86.o
	$(x86_64_cross_prefix)objcopy -O binary x86.o x86.boot
	dd if=x86.boot of=x86.bootsect bs=256 count=2 skip=124
	echo "$$__note" > $@
	xxd -i x86.bootsect | sed -e 's/.*int.*//' >> $@

aarch64-a-b-kernel.h: aarch64-a-b-kernel.S
	$(aarch64_cross_prefix)gcc -o aarch64.elf -nostdlib \
		-Wl,--build-id=none,-Ttext=40080000 $<
	$(aarch64_cross_prefix)objcopy -O binary aarch64.elf aarch64.kernel
	echo "$$__note" > $@
	xxd -i aarch64.kernel | sed -e 's/.*int.*//' >> $@

clean:
	rm -f *.bootsect *.boot *.o *.elf *.kernel
